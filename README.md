# ARX 机器人 LeRobot 推理与数据采集仓库

本项目包含了在（ARX）双臂机器人上，使用 `lerobot` (特别是 `PI0Policy`) 进行实时推理和数据采集所需的核心代码。

项目采用 ROS 2 (`rclpy`) 进行硬件通信，并使用 `multiprocessing` 和 `SharedMemory`（共享内存）在 ROS 进程和 AI 推理进程之间实现低延迟的数据交换。

## 核心文件概览

### 🤖 1. 核心逻辑

* `arx_lerobot.py`
    * **用途**: pi0 推理适配代码，还未经调试，是初版。
    * **工作原理**: 这是项目的核心。它启动两个独立的进程：
        1.  **`ros_process`**: 运行 `rclpy`，专门负责与 ROS 2 硬件（相机、机械臂）通信，并将传感器数据写入共享内存。
        2.  **`inference_process`**: 专门负责运行 AI 模型。它从共享内存中读取数据，加载 `PI0Policy` 模型进行推理，然后将计算出的“动作”写回共享内存，由 `ros_process` 读取并执行。

* `collect_arm_once.py`
    * **用途**: **数据采集脚本**。
    * **工作原理**: 运行一个 ROS 2 节点 (`ArmDataCollector`)，它订阅所有的相机和机械臂状态话题（`qpos`, `eef` 等）。它被设计用来录制**一条**完整的“专家演示”轨迹，并在用户确认后将其保存为 `HDF5` 文件，用于模型训练。

### 🚀 2. 启动器 (Bash 脚本)

* `collect_lift_once.sh`
    * **用途**: **启动“数据采集”模式**。
    * **工作原理**: 这是一个总启动脚本。它会在多个 `gnome-terminal` 窗口中启动所有必需的硬件驱动（CAN 总线、升降柱、相机节点）。然后，它进入一个循环：启动机械臂的重力补偿（遥操作）模式，然后运行 `collect_arm_once.py` 等待用户录制一条数据，最后自动复位机械臂，并询问是否开始下一条。

* `inference.sh`
    * **用途**: **启动“AI 推理”模式**。
    * **工作原理**: 与 `collect_lift_once.sh` 类似，它是一个总启动脚本，用于启动所有硬件驱动（CAN、升降柱、相机）。最后，它会启动 `arx_lerobot.py` 脚本，让 AI 模型接管机器人进行自主操作。

* `stop_all.sh`
    * **用途**: **紧急停止/清理脚本**。
    * **工作原理**: 一个安全脚本，用于强行终止（`pkill -9`）所有与机器人相关的进程，包括 ROS 2 节点、相机驱动和 CAN 总线连接。每次运行完推理都需要运行一下这个脚本。

### 🛠️ 3. 辅助工具与测试

* `test_oom.py`
    * **用途**: **模型加载与显存（OOM）测试**。
    * **工作原理**: 加载 `PI0Policy` 模型，并向其提供随机生成的模拟数据（图像和状态），以测试模型是否能成功运行（`select_action`）而不会导致显存溢出 (Out of Memory)。

* `data_read.py`
    * **用途**: **HDF5 数据检查器**。
    * **工作原理**: 读取一个 `.hdf5` 数据文件，打印其内部结构、属性和一些数据的平均值，用于调试数据采集是否成功。

* `test.py`
    * **用途**: **数据集完整性检查器**。
    * **工作原理**: 遍历一个文件夹中的所有 `.hdf5` 文件，尝试打开它们，以检查哪些文件已损坏，并列出损坏文件的删除命令。

* `converter/hdf5`
    * **用途**: **将采集好的hdf5数据集转化为标准LeRobot格式**。
    * **命令**: `cd converter/hdf5; python convert_lerobot.py --config config.yaml`